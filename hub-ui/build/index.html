<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GADS Hub</title>
    <link rel="icon" type="image/png" href="/images/android-logo.png" />
    <style>
      :root {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        color: #0b1526;
        background-color: #f5f7fb;
      }
      body { margin: 0; }
      a { color: inherit; text-decoration: none; }
      .app-shell { display: grid; grid-template-columns: 240px 1fr; min-height: 100vh; }
      nav { background: #0f1a2c; color: #fff; padding: 24px 16px; }
      nav h1 { font-size: 18px; margin: 0 0 16px; }
      nav ul { list-style: none; padding: 0; margin: 0; }
      nav li { margin-bottom: 10px; }
      nav a { color: #cbd5e1; font-weight: 600; }
      nav a.active { color: #fff; }
      main { padding: 24px; background: #f5f7fb; }
      .card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); }
      .card h2 { margin-top: 0; }
      input, select, textarea, button { font: inherit; }
      input, select, textarea { width: 100%; padding: 10px; margin: 8px 0; border-radius: 8px; border: 1px solid #cbd5e1; box-sizing: border-box; }
      button { background: #1d4ed8; color: #fff; border: none; border-radius: 8px; padding: 10px 16px; cursor: pointer; font-weight: 700; }
      button.secondary { background: #e2e8f0; color: #0b1526; }
      .table { width: 100%; border-collapse: collapse; }
      .table th, .table td { padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0; }
      .badge { display: inline-block; padding: 4px 10px; border-radius: 999px; background: #e0f2fe; color: #075985; font-weight: 700; font-size: 12px; }
      .flex { display: flex; gap: 12px; align-items: center; }
      .topbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
      .section-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
      .code-block { font-family: 'SFMono-Regular', Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; background: #0f172a; color: #e2e8f0; padding: 12px; border-radius: 8px; overflow-x: auto; }
      .alert { border: 1px solid #e2e8f0; background: #f8fafc; padding: 12px; border-radius: 8px; }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/react-router-dom@6/umd/react-router-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { BrowserRouter, Routes, Route, Navigate, NavLink, useNavigate } = ReactRouterDOM;

      const AuthContext = React.createContext(null);

      function AuthProvider({ children }) {
        const [token, setToken] = React.useState(() => localStorage.getItem('hub_token'));
        const [user, setUser] = React.useState(() => {
          const stored = localStorage.getItem('hub_user');
          return stored ? JSON.parse(stored) : null;
        });

        React.useEffect(() => {
          if (token) localStorage.setItem('hub_token', token);
          else localStorage.removeItem('hub_token');
        }, [token]);

        React.useEffect(() => {
          if (user) localStorage.setItem('hub_user', JSON.stringify(user));
          else localStorage.removeItem('hub_user');
        }, [user]);

        const value = React.useMemo(() => ({ token, setToken, user, setUser, isAuthenticated: Boolean(token) }), [token, user]);
        return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
      }

      function useAuth() {
        return React.useContext(AuthContext);
      }

      function useApi() {
        const { token } = useAuth();
        const request = React.useCallback(async (path, options = {}) => {
          const headers = new Headers(options.headers || {});
          if (!headers.has('Content-Type') && !(options.body instanceof FormData)) headers.set('Content-Type', 'application/json');
          if (token) headers.set('Authorization', `Bearer ${token}`);
          const response = await fetch(path, { ...options, headers });
          const text = await response.text();
          const data = text ? JSON.parse(text) : null;
          if (!response.ok) throw new Error(data?.error || response.statusText);
          return data;
        }, [token]);
        return { request };
      }

      function Sidebar() {
        const { isAuthenticated, setToken, setUser } = useAuth();
        const logout = () => { setToken(null); setUser(null); };
        return (
          <nav>
            <h1>GADS Hub</h1>
            {isAuthenticated ? (
              <>
                <ul>
                  <li><NavLink to="/" end>Dashboard</NavLink></li>
                  <li><NavLink to="/providers">Providers</NavLink></li>
                  <li><NavLink to="/devices">Devices</NavLink></li>
                  <li><NavLink to="/users">Users</NavLink></li>
                  <li><NavLink to="/files">Files</NavLink></li>
                  <li><NavLink to="/settings">Global settings</NavLink></li>
                  <li><NavLink to="/workspaces">Workspaces</NavLink></li>
                  <li><NavLink to="/secret-keys">Secret keys</NavLink></li>
                  <li><NavLink to="/client-credentials">Client credentials</NavLink></li>
                </ul>
                <button className="secondary" onClick={logout} style={{ marginTop: 16 }}>Logout</button>
              </>
            ) : <p>Login required</p>}
          </nav>
        );
      }

      function ProtectedRoute({ children }) {
        const { isAuthenticated } = useAuth();
        if (!isAuthenticated) return <Navigate to="/login" replace />;
        return children;
      }

      function LoginPage() {
        const [username, setUsername] = React.useState('');
        const [password, setPassword] = React.useState('');
        const [error, setError] = React.useState(null);
        const navigate = useNavigate();
        const { setToken, setUser } = useAuth();
        const { request } = useApi();
        const submit = async (e) => {
          e.preventDefault();
          setError(null);
          try {
            const res = await request('/authenticate', { method: 'POST', body: JSON.stringify({ username, password }) });
            setToken(res.access_token);
            setUser({ username: res.username, role: res.role });
            navigate('/');
          } catch (err) { setError(err.message); }
        };
        return (
          <div style={{ maxWidth: 480, margin: '80px auto' }} className="card">
            <h2>Hub login</h2>
            <p>Please authenticate to access the device farm.</p>
            <form onSubmit={submit}>
              <label htmlFor="username">Username</label>
              <input id="username" value={username} onChange={(e) => setUsername(e.target.value)} required />
              <label htmlFor="password">Password</label>
              <input id="password" type="password" value={password} onChange={(e) => setPassword(e.target.value)} required />
              <button type="submit">Login</button>
            </form>
            {error && <p style={{ color: 'crimson' }}>{error}</p>}
          </div>
        );
      }

      function DashboardPage() {
        const [availableDevices, setAvailableDevices] = React.useState([]);
        const [userInfo, setUserInfo] = React.useState(null);
        const [error, setError] = React.useState(null);
        const { request } = useApi();
        const { user } = useAuth();
        React.useEffect(() => { request('/user-info').then(setUserInfo).catch((err) => setError(err.message)); }, [request]);
        React.useEffect(() => {
          const es = new EventSource('/available-devices');
          es.onmessage = (event) => { try { const payload = JSON.parse(event.data); setAvailableDevices(payload.devices || []); } catch (err) { console.error(err); } };
          es.onerror = () => setError('Live device stream unavailable');
          return () => es.close();
        }, []);
        return (
          <div className="card">
            <div className="topbar">
              <div>
                <h2>Welcome back{user ? `, ${user.username}` : ''}</h2>
                <p>Monitor available devices and your account details.</p>
              </div>
              {user && <span className="badge">{user.role}</span>}
            </div>
            {error && <div className="alert">{error}</div>}
            <div className="section-grid">
              <div className="card">
                <h4>User info</h4>
                {userInfo ? <pre className="code-block">{JSON.stringify(userInfo, null, 2)}</pre> : <p>Loading account details…</p>}
              </div>
              <div className="card">
                <h4>Available devices</h4>
                {availableDevices.length === 0 ? <p>No devices currently available.</p> : (
                  <ul>
                    {availableDevices.map((device) => <li key={device.udid}><strong>{device.name || device.udid}</strong> — {device.platform}</li>)}
                  </ul>
                )}
              </div>
            </div>
          </div>
        );
      }

      function ResourceManager({ title, listPath, createPath, createMethod = 'POST', updatePath, updateMethod = 'POST', deletePath, identifierLabel = 'id' }) {
        const { request } = useApi();
        const [items, setItems] = React.useState([]);
        const [error, setError] = React.useState(null);
        const [body, setBody] = React.useState('{}');
        const [refreshKey, setRefreshKey] = React.useState(0);
        const [deleteId, setDeleteId] = React.useState('');

        React.useEffect(() => {
          if (!listPath) return;
          request(listPath)
            .then((data) => setItems(Array.isArray(data) ? data : data?.devices || data?.providers || data?.users || []))
            .catch((err) => setError(err.message));
        }, [listPath, refreshKey, request]);

        const submit = async (path, method) => {
          setError(null);
          try { await request(path, { method, body }); setRefreshKey((x) => x + 1); }
          catch (err) { setError(err.message); }
        };

        const remove = async () => {
          if (!deletePath || !deleteId) return;
          setError(null);
          try { await request(`${deletePath}/${deleteId}`, { method: 'DELETE' }); setRefreshKey((x) => x + 1); setDeleteId(''); }
          catch (err) { setError(err.message); }
        };

        return (
          <div className="card">
            <div className="topbar">
              <div>
                <h3>{title}</h3>
                <p>Interact with the {title.toLowerCase()} endpoints.</p>
              </div>
              <button className="secondary" onClick={() => setRefreshKey((x) => x + 1)}>Refresh</button>
            </div>
            {error && <div className="alert">{error}</div>}
            <div className="section-grid">
              <div className="card">
                <h4>Current data</h4>
                {items.length === 0 ? <p>No records yet.</p> : <pre className="code-block">{JSON.stringify(items, null, 2)}</pre>}
              </div>
              <div className="card">
                <h4>Create or update</h4>
                <p>Submit raw JSON to the backend APIs.</p>
                <textarea rows={8} value={body} onChange={(e) => setBody(e.target.value)} />
                <div className="flex">
                  {createPath && <button onClick={() => submit(createPath, createMethod)}>Create</button>}
                  {updatePath && <button className="secondary" onClick={() => submit(updatePath, updateMethod)}>Update</button>}
                </div>
              </div>
              {deletePath && (
                <div className="card">
                  <h4>Delete</h4>
                  <label htmlFor={`delete-${title}`}>{identifierLabel}</label>
                  <input id={`delete-${title}`} placeholder={`Enter ${identifierLabel}`} value={deleteId} onChange={(e) => setDeleteId(e.target.value)} />
                  <button className="secondary" onClick={remove}>Delete</button>
                </div>
              )}
            </div>
          </div>
        );
      }

      const ProvidersPage = () => <ResourceManager title="Providers" listPath="/admin/providers" createPath="/admin/providers/add" updatePath="/admin/providers/update" deletePath="/admin/providers" identifierLabel="nickname" />;
      const DevicesPage = () => <ResourceManager title="Devices" listPath="/admin/devices" createPath="/admin/device" updatePath="/admin/device" updateMethod="PUT" deletePath="/admin/device" identifierLabel="udid" />;
      const UsersPage = () => <ResourceManager title="Users" listPath="/admin/users" createPath="/admin/user" updatePath="/admin/user" updateMethod="PUT" deletePath="/admin/user" identifierLabel="nickname" />;
      const WorkspacesPage = () => <ResourceManager title="Workspaces" listPath="/admin/workspaces" createPath="/admin/workspaces" updatePath="/admin/workspaces" updateMethod="PUT" deletePath="/admin/workspaces" identifierLabel="id" />;
      const SecretKeysPage = () => <ResourceManager title="Secret keys" listPath="/admin/secret-keys" createPath="/admin/secret-keys" updatePath="/admin/secret-keys" updateMethod="PUT" deletePath="/admin/secret-keys" identifierLabel="id" />;
      const ClientCredentialsPage = () => <ResourceManager title="Client credentials" listPath="/client-credentials" createPath="/client-credentials" updatePath="/client-credentials" updateMethod="PUT" deletePath="/client-credentials" identifierLabel="id" />;

      function FilesPage() {
        const { request } = useApi();
        const [files, setFiles] = React.useState([]);
        const [selected, setSelected] = React.useState(null);
        const [error, setError] = React.useState(null);
        const [loading, setLoading] = React.useState(false);
        const load = () => { setError(null); request('/admin/files').then(setFiles).catch((err) => setError(err.message)); };
        React.useEffect(() => { load(); }, []);
        const upload = async (e) => {
          e.preventDefault(); if (!selected) return; setLoading(true); setError(null);
          try { const formData = new FormData(); formData.append('file', selected); await request('/admin/upload-file', { method: 'POST', body: formData }); setSelected(null); load(); }
          catch (err) { setError(err.message); }
          finally { setLoading(false); }
        };
        return (
          <div className="card">
            <div className="topbar">
              <div><h3>Files</h3><p>Upload resources and inspect the stored assets.</p></div>
              <button className="secondary" onClick={load}>Refresh</button>
            </div>
            {error && <div className="alert">{error}</div>}
            <div className="card">
              <h4>Upload file</h4>
              <form onSubmit={upload}>
                <input type="file" onChange={(e) => setSelected(e.target.files?.[0] || null)} required />
                <button type="submit" disabled={loading}>{loading ? 'Uploading…' : 'Upload'}</button>
              </form>
            </div>
            <div className="card">
              <h4>Stored files</h4>
              {files.length === 0 ? <p>No files available.</p> : (
                <table className="table">
                  <thead><tr><th>Name</th><th>Type</th><th>Size (bytes)</th></tr></thead>
                  <tbody>{files.map((file) => <tr key={file.id || file.name}><td>{file.name}</td><td>{file.type}</td><td>{file.size}</td></tr>)}</tbody>
                </table>
              )}
            </div>
          </div>
        );
      }

      function SettingsPage() {
        const { request } = useApi();
        const [settings, setSettings] = React.useState(null);
        const [draft, setDraft] = React.useState('{}');
        const [error, setError] = React.useState(null);
        React.useEffect(() => {
          request('/admin/global-settings').then((data) => { setSettings(data); setDraft(JSON.stringify(data, null, 2)); }).catch((err) => setError(err.message));
        }, [request]);
        const save = async () => {
          setError(null);
          try { await request('/admin/global-settings', { method: 'POST', body: draft }); const latest = await request('/admin/global-settings'); setSettings(latest); setDraft(JSON.stringify(latest, null, 2)); }
          catch (err) { setError(err.message); }
        };
        return (
          <div className="card">
            <div className="topbar">
              <div><h3>Global streaming settings</h3><p>Adjust parameters used by providers and devices.</p></div>
              <button className="secondary" onClick={save}>Save changes</button>
            </div>
            {error && <div className="alert">{error}</div>}
            <div className="section-grid">
              <div className="card">
                <h4>Current values</h4>
                {settings ? <pre className="code-block">{JSON.stringify(settings, null, 2)}</pre> : <p>Loading…</p>}
              </div>
              <div className="card">
                <h4>Edit JSON</h4>
                <textarea rows={12} value={draft} onChange={(e) => setDraft(e.target.value)} />
                <p className="alert">JSON is sent directly to the backend API.</p>
              </div>
            </div>
          </div>
        );
      }

      function Shell() {
        return (
          <div className="app-shell">
            <Sidebar />
            <main>
              <Routes>
                <Route path="/" element={<ProtectedRoute><DashboardPage /></ProtectedRoute>} />
                <Route path="/providers" element={<ProtectedRoute><ProvidersPage /></ProtectedRoute>} />
                <Route path="/devices" element={<ProtectedRoute><DevicesPage /></ProtectedRoute>} />
                <Route path="/users" element={<ProtectedRoute><UsersPage /></ProtectedRoute>} />
                <Route path="/files" element={<ProtectedRoute><FilesPage /></ProtectedRoute>} />
                <Route path="/settings" element={<ProtectedRoute><SettingsPage /></ProtectedRoute>} />
                <Route path="/workspaces" element={<ProtectedRoute><WorkspacesPage /></ProtectedRoute>} />
                <Route path="/secret-keys" element={<ProtectedRoute><SecretKeysPage /></ProtectedRoute>} />
                <Route path="/client-credentials" element={<ProtectedRoute><ClientCredentialsPage /></ProtectedRoute>} />
                <Route path="/login" element={<LoginPage />} />
                <Route path="*" element={<Navigate to="/" replace />} />
              </Routes>
            </main>
          </div>
        );
      }

      function App() {
        return (
          <AuthProvider>
            <BrowserRouter>
              <Shell />
            </BrowserRouter>
          </AuthProvider>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
